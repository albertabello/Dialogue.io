var scripts=document.getElementsByTagName("script");var myScript=scripts[scripts.length-1];var queryString=myScript.src.replace(/^[^\?]+\??/,"");var params=parseQuery(queryString);function parseQuery(d){var e=new Object();if(!d){return e}var a=d.split(/[;&]/);for(var c=0;c<a.length;c++){var g=a[c].split("=");if(!g||g.length!=2){continue}var b=unescape(g[0]);var f=unescape(g[1]);f=f.replace(/\+/g," ");e[b]=f}return e}console.log(params.id);function getElement(a){var b;if(typeof a==="string"){b=document.getElementById(a)}else{if(!a){return false}}return b}function Meeting(a,b,c){this.localVideo=getElement(a);this.remoteVideo=getElement(b);this.statusDiv=c;this.peerConn=null;this.localStream=null;this.caller=false;this.gotMedia=true;this.SDP_content=null;console.log("New Meeting object created");Meeting.prototype.Call=function(){Meeting.caller=true;getUserMedia(maybeStart())};Meeting.prototype.Message=function(d){Meeting.SDP_content=d;if(Meeting.localStream==null){Meeting.gotMedia=false;getUserMedia()}else{console.log("S->C: "+d);if(d!="BYE"){if(d.indexOf('"ERROR"',0)==-1){if(Meeting.peerConn==null){maybeStart();Meeting.peerConn.processSignalingMessage(d)}else{Meeting.peerConn.processSignalingMessage(d)}}}else{console.log("Session terminated");console.log("Hanging up.");Meeting.localVideo.style.opacity=0;Meeting.localVideo=null;Meeting.remoteVideo.style.opacity=0;Meeting.remoteVideo=null;Meeting.peerConn.close();console.log("Ready for next call");Meeting.peerConn=null;Meeting.localStream=null;Meeting.caller=0;setStatus("")}}};getUserMedia=function(f){try{navigator.webkitGetUserMedia({audio:true,video:true},onUserMediaSuccess,onUserMediaError);console.log("Requested access to local media with new syntax.")}catch(d){try{navigator.webkitGetUserMedia("video,audio",onUserMediaSuccess,onUserMediaError);console.log("Requested access to local media with old syntax.")}catch(d){alert("webkitGetUserMedia() failed. Is the MediaStream flag enabled in about:flags?");console.log("webkitGetUserMedia failed with exception: "+d.message)}}};onUserMediaError=function(d){console.log("Failed to get access to local media. Error code was "+d.code);alert("Failed to get access to local media. Error code was "+d.code+".")};onUserMediaSuccess=function(e){console.log("Hurray! We have access to audio/video");var d=webkitURL.createObjectURL(e);Meeting.localVideo.style.opacity=1;Meeting.localVideo.src=d;Meeting.localStream=e;if(Meeting.gotMedia==false){Meeting.gotMedia=true;Meeting.Message(Meeting.SDP_content)}if(Meeting.caller==true){maybeStart()}};sendMessage=function(d){var e=d;console.log("C->S: "+e);$.ajax({type:"GET",url:"http://vr000m.ath.cx:8000/widgetCall/",data:e,dataType:"json",success:function(f){console.log(f)}})};setStatus=function(d){document.getElementById(Meeting.statusDiv).innerHTML=d};maybeStart=function(){if(Meeting.localStream){setStatus("Connecting...");createPeerConnection();console.log("Adding local stream");Meeting.peerConn.addStream(Meeting.localStream);started=true}};resetStatus=function(){setStatus("Waiting for your buddy")};createPeerConnection=function(){setStatus("Connecting...");console.log("Creating PeerConnection");try{Meeting.peerConn=new webkitJsep00PeerConnection("STUN stun.l.google.com:19302",sendMessage);console.log('Created webkitDeprecatedPeerConnnection with config "STUN stun.l.google.com:19302".')}catch(d){console.log("Failed to create webkitJsep00PeerConnection, exception: "+d.message);try{Meeting.peerConn=new webkitDeprecatedPeerConnection("STUN stun.l.google.com:19302",sendMessage);console.log('Created webkitDeprecatedPeerConnnection with config "STUN stun.l.google.com:19302".')}catch(d){console.log("Failed to create webkitDeprecatedPeerConnection, exception: "+d.message);try{Meeting.peerConn=new webkitPeerConnection("STUN stun.l.google.com:19302",sendMessage);console.log('Created webkitDeprecatedPeerConnnection with config "STUN stun.l.google.com:19302".')}catch(d){console.log("Failed to create webkitPeerConnection, exception: "+d.message);alert("Cannot create PeerConnection object; Is the 'PeerConnection' flag enabled in about:flags?");return}}}Meeting.peerConn.onconnecting=onSessionConnecting;Meeting.peerConn.onopen=onSessionOpened;Meeting.peerConn.onaddstream=startShowingStream;Meeting.peerConn.onremovestream=onRemoteStreamRemoved};onSessionConnecting=function(d){console.log("Session connecting.")};onSessionOpened=function(d){console.log("Session opened.")};startShowingStream=function(d){console.log("Remote stream added.");var e=webkitURL.createObjectURL(event.stream);Meeting.remoteVideo.style.opacity=1;Meeting.remoteVideo.src=e;setStatus('<input type="button" id="hangup" value="Hang up" onclick="onHangup()" />')};onChannelError=function(){console.log("Channel error.")};onChannelClosed=function(){console.log("Channel closed.")};onRemoteStreamRemoved=function(d){console.log("Remote stream removed")};onHangup=function(){console.log("Hanging up.");socket.send({id:"{{owner.id}}",action:"video_sdp",message:"BYE",to_who_id:located_friend.id});Meeting.localVideo.style.opacity=0;Meeting.remoteVideo.style.opacity=0;Meeting.peerConn.close();console.log("Ready for next call");Meeting.peerConn=null;Meeting.localStream=null;Meeting.caller=0;setStatus("")}}div=document.getElementById("webrtc-widget");remote_tag=document.createElement("video");remote_tag.setAttribute("id","remote_video");remote_tag.setAttribute("autoplay","autoplay");remote_tag.setAttribute("style","-webkit-transition: opacity 2s; -webkit-transform: scale(-1, 1); opacity: 1; max-width: 100%; height: auto; padding-top: 10px;");div.appendChild(remote_tag);local_tag=document.createElement("video");local_tag.setAttribute("id","local_video");local_tag.setAttribute("autoplay","autoplay");local_tag.setAttribute("style","-webkit-transition: opacity 2s; -webkit-transform: scale(-1, 1); opacity: 1; max-width: 100%; height: auto; padding-top: 10px;");div.appendChild(local_tag);call_button=document.createElement("button");call_button.setAttribute("id","call_btn");call_button.setAttribute("onclick","Meeting.Call()");text=document.createTextNode("Call me!");call_button.appendChild(text);div.appendChild(call_button);footer=document.createElement("div");footer.setAttribute("id","status");div.appendChild(footer);Meeting=new Meeting("local_video","remote_video","status");